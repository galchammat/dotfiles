# APT PACKAGES
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  become: yes

- name: Install apt packages
  apt:
    name:
      # Package Managers
      - flatpak

      # Window Manager & Desktop
      - autorandr
      - dbus-x11
      - dmenu
      - feh
      - i3
      - picom

      # Terminal & Shell
      - alacritty
      - tmux
      - zsh

      # Development Tools
      - build-essential
      - cmake
      - curl
      - gettext
      - git
      - gh
      - libgtk-3-dev
      - libwebkit2gtk-4.1-dev
      - ninja-build
      - sqlite3
      - unzip

      # CLI Utilities
      - pass
      - ripgrep

      # Audio
      - pavucontrol
      - pipewire
      - pipewire-pulse
      - wireplumber
      - libspa-0.2-bluetooth

      # Clipboard
      - wl-clipboard
      - xclip

      # Security & Privacy
      - gnupg2
      - openssh-server
      - rng-tools

      # System Tools
      - netdata
      - refind

      # Pop!_OS Specific
      - libpop-upgrade-gtk
      - pop-upgrade

    state: present
  become: yes
 
# FLATPAK SETUP
- name: Add Flathub repository
  flatpak_remote:
    name: flathub
    state: present
    flatpakrepo_url: https://flathub.org/repo/flathub.flatpakrepo
  become: yes

- name: Install Discord via Flatpak
  flatpak:
    name: com.discordapp.Discord
    state: present
    remote: flathub
    method: system
  become: yes

- name: Install Flameshot via Flatpak
  flatpak:
    name: org.flameshot.Flameshot
    state: present
    remote: flathub
    method: system
  become: yes

# EXTERNAL DEB PACKAGES
- name: Check if Cloudflared is already installed
  ansible.builtin.command: which cloudflared
  register: cloudflared_check
  changed_when: false
  failed_when: false
  no_log: true

- name: Download Cloudflared
  get_url:
    url: "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb"
    dest: "/tmp/cloudflared.deb"
  become: yes
  when:
    - cloudflared_check.rc != 0
    - not ansible_check_mode

- name: Install Cloudflared
  apt:
    deb: "/tmp/cloudflared.deb"
    state: present
  become: yes
  when:
    - cloudflared_check.rc != 0
    - not ansible_check_mode

- name: Clean up Cloudflared deb
  file:
    path: "/tmp/cloudflared.deb"
    state: absent
  become: yes
  when: not ansible_check_mode

# BUILD NEOVIM FROM SOURCE
- name: Check if Neovim is already installed
  ansible.builtin.command: which nvim
  register: nvim_check
  changed_when: false
  failed_when: false
  no_log: true

- name: Install Neovim build dependencies
  apt:
    name:
      - ninja-build
      - gettext
      - cmake
      - unzip
      - curl
      - build-essential
    state: present
  become: yes
  when: nvim_check.rc != 0

- name: Clone Neovim repository
  git:
    repo: 'https://github.com/neovim/neovim.git'
    dest: '/tmp/neovim'
    version: stable
    depth: 1
  when:
    - nvim_check.rc != 0
    - not ansible_check_mode

- name: Build Neovim
  shell: |
    cd /tmp/neovim
    make CMAKE_BUILD_TYPE=RelWithDebInfo
  args:
    creates: /tmp/neovim/build/bin/nvim
  when:
    - nvim_check.rc != 0
    - not ansible_check_mode

- name: Install Neovim
  shell: |
    cd /tmp/neovim
    make install
  become: yes
  args:
    creates: /usr/local/bin/nvim
  when:
    - nvim_check.rc != 0
    - not ansible_check_mode

- name: Clean up Neovim source
  file:
    path: /tmp/neovim
    state: absent
  when: not ansible_check_mode

# INSTALL OPENCODE
- name: Check if OpenCode is already installed
  ansible.builtin.command: which opencode
  register: opencode_check
  changed_when: false
  failed_when: false
  no_log: true

- name: Install OpenCode globally via npm
  ansible.builtin.shell: |
    source {{ ansible_facts['user_dir'] }}/.nvm/nvm.sh
    npm install -g opencode-ai
  args:
    executable: /bin/bash
  when: 
    - opencode_check.rc != 0
    - not ansible_check_mode

