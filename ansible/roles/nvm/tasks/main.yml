---
# NVM (Node Version Manager) Installation and Configuration

- name: "NVM | Check if NVM is already installed"
  ansible.builtin.stat:
    path: "{{ ansible_facts['user_dir'] }}/.nvm/nvm.sh"
  register: nvm_stat

- name: "NVM | Install NVM dependencies"
  ansible.builtin.apt:
    name:
      - curl
      - git
    state: present
  become: true
  when: not nvm_stat.stat.exists

- name: "NVM | Download and install NVM"
  ansible.builtin.shell: >
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
  args:
    creates: "{{ ansible_facts['user_dir'] }}/.nvm/nvm.sh"
    executable: /bin/bash
  when: not nvm_stat.stat.exists

- name: "NVM | Check if Node.js LTS is installed"
  ansible.builtin.shell: |
    export NVM_DIR="{{ ansible_facts['user_dir'] }}/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm version default
  args:
    executable: /bin/bash
  register: node_version_check
  changed_when: false
  failed_when: false
  no_log: true

- name: "NVM | Install Node.js LTS"
  ansible.builtin.shell: |
    export NVM_DIR="{{ ansible_facts['user_dir'] }}/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm install --lts
    nvm alias default lts/*
    nvm use default
  args:
    executable: /bin/bash
  when: 
    - node_version_check.rc != 0 or node_version_check.stdout == ''
    - not ansible_check_mode
  register: node_install

- name: "NVM | Get installed Node.js version"
  ansible.builtin.shell: |
    export NVM_DIR="{{ ansible_facts['user_dir'] }}/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    node --version
  args:
    executable: /bin/bash
  register: node_version
  changed_when: false
  when: not ansible_check_mode

- name: "NVM | Display Node.js version"
  ansible.builtin.debug:
    msg: "Node.js {{ node_version.stdout }} is installed via NVM"
  when: 
    - not ansible_check_mode
    - node_version.stdout is defined

- name: "NVM | Ensure NVM is sourced in .zshrc"
  ansible.builtin.blockinfile:
    path: "{{ ansible_facts['user_dir'] }}/.zshrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - NVM"
    block: |
      # NVM - Node Version Manager
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
      [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion
    create: false
    insertafter: EOF
  when: ansible_facts['user_shell'] is search('zsh')

- name: "NVM | Ensure NVM is sourced in .bashrc"
  ansible.builtin.blockinfile:
    path: "{{ ansible_facts['user_dir'] }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - NVM"
    block: |
      # NVM - Node Version Manager
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
      [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion
    create: false
    insertafter: EOF
